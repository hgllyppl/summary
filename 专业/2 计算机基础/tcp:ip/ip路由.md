# 本篇说明
本系列为《tcp/ip 详解-卷1》浓缩，本篇IP路由浓缩。<br>
<span style="color:red">红字</span>为重要说明，<span style="color:orange">橙字</span>为不确定说明，<span style="color:green">绿字</span>待定。

# IP 路由

## IP 路由
从概念上说，IP路由的选择是简单的，特别对于主机来说。如果目的主机与源主机直接相连（如点对点链路）或都在一个共享网络上（以太网或令牌环网），那么IP数据报就直接送到目的主机上。否则，主机把数据报发往默认的路由器，由路由器来转发该数据报。

一般的情况下，IP可以从TCP、UDP、ICMP和IGMP接收数据报并进行发送，或者从一个网络接口接收数据报并进行发送。IP层在内存中有一个路由表，当收到一份数据报并进行发送时，它都要对该表搜索一次。
当数据报来自某个网络接口时，IP首先检查目的IP地址是否为本机的IP地址之一或者IP广播地址。如果是这样，数据报就被送到由IP首部协议字段所指定的协议模块进行处理。如果数据报的目的不是这些地址，那么如果IP层被设置为路由器的功能，那么就对数据报进行转发；否则，数据报被丢弃。

下面来看一看路由表：

![](./ip路由/路由表.png)

如上图所示，路由表包含以下信息：

- 目的IP地址，它既可以是一个完整的主机地址，也可以是一个网络地址，由表目中的标志字段来确定（如下所述）。
- 下一跳路由器（next-hop router）的IP地址，或者直连网络的IP地址。
- 标志
    - U 该路由可以使用
    - G 该路由是到一个网关(路由器)，没有此标志，则说明目的地是直连的，该标志区分了是直接还是间接路由。
    - H 该路由是到一个主机，也就是说，目的地址是一个完整的主机地址。没有此标志，则说明该路由是到一个网络
- Refcnt，正在使用该路由的活动进程个数
- Use，通过该路由发送的分组数
- Interface，该路由所使用的网络接口

IP路由是逐跳（hop-by-hop）进行的，从上面的路由表信息可以看出，IP并不知道任何目的地的完整路径（除了那些与主机直连的目的地）。所有的IP路由只为数据报传输提供下一站路由器的IP地址，它假定下一站路由器比发送数据报的主机更接近目的地。

IP路由主要完成以下这些功能：

- 搜索匹配的主机地址
- 搜索匹配的网络地址
- 搜索默认表项
- 如果以上步骤不成功，如果数据报是由本机产生的，那么就给发送数据报的应用程序返回一个“主机不可达”或“网络不可达”的差错；如果是被转发的数据报，那么就给源端发送一份ICMP主机不可达的差错报文。

### 例子
参考《tcp/ip详解-卷1》3.3一节

## 路由的原理
如下图所示，它描述了一个路由守护程序（daemon）。路由表经常被IP访问（在一个繁忙的主机上，一秒钟内可能要访问几百次），但是它被路由守护程序更新的频率却要低得多（可能大约30秒种一次），除路由守护程序外，路由表还可能被route命令以及ICMP重定向报文更新。

![](./ip路由/路由图示.png)

### 初始化路由表
一个常用的方法是在系统引导时显式地在初始化文件中运行route命令，但不幸的是，几乎没有系统愿意在启动文件中包含route命令。

初始化路由表的其他方法是运行路由守护程序或者使用路由器发现协议。

## ICMP 主机或网络不可达差错

## ICMP 重定向差错

## ICMP 路由器发现报文

# 参考引用
0. [tcp/ip详解-卷1](https://book.douban.com/subject/1088054/)
